# å°ˆæ¡ˆæŠ€è¡“æ¸…å–®

## 1. ç¶²ç«™æŠ˜åƒ¹åˆ¸åŠŸèƒ½
- **åŠŸèƒ½èªªæ˜**ï¼š
  1. **æŠ˜åƒ¹åˆ¸æ´»å‹•çš„å»ºç«‹èˆ‡ç®¡ç†**
     - æ”¯æ´å¤šç¨®æ´»å‹•é¡å‹ï¼ˆå¦‚ç™»å…¥é€ã€åŒ¯å…¥ã€ç•°æ¥­åˆä½œç­‰ï¼‰ã€‚
     - æä¾›æ´»å‹•çš„å•Ÿç”¨ã€åœç”¨ã€åˆªé™¤èˆ‡è¤‡è£½åŠŸèƒ½ã€‚
     - æ”¯æ´æ´»å‹•çš„è©³ç´°è¨­å®šï¼ŒåŒ…æ‹¬æœ‰æ•ˆæœŸé™ã€æŠ˜æ‰£é¡å‹ï¼ˆå®šé¡æˆ–å®šç‡ï¼‰ã€é€šè·¯é™å®šç­‰ã€‚
     - æ”¯æ´æ‰¹æ¬¡åŒ¯å…¥å®¢æˆ¶è³‡æ–™ã€‚
     - æä¾›å¯©æ ¸äººå“¡çš„ç®¡ç†èˆ‡æ¬Šé™æª¢æŸ¥åŠŸèƒ½ã€‚

- **æŠ€è¡“ä½¿ç”¨**ï¼šC#, ASP.NET MVC, MSSQL
- **C# TransactionScope ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§**ï¼š
    ```csharp
      public bool SaveVoucher(VoucherMaster voucher, string createdBy = "")
      {
          bool result = false;
      
          using (var transactionScope = new TransactionScope(TransactionScopeOption.Required, new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted }))
          {
              if (voucher.ID != 0)
              {
                  result = VoucherRepository.UpdateVoucherMaster(voucher);
              }
              else
              {
                  voucher.ID = VoucherRepository.CreateVoucherMaster(voucher, createdBy);
                  result = voucher.ID > 0;
              }
      
              if (result)
              {
                  int order = 1;
                  VoucherRepository.DeleteVoucherDetails(voucher.ID);
                  foreach (var detail in voucher.Detail ?? Enumerable.Empty<VoucherDetail>())
                  {
                      VoucherRepository.InsertVoucherDetail(voucher.ID, detail, order++);
                  }
              }
      
              transactionScope.Complete();
          }
      
          return result;
      }
    ```

## 2. ç›´æ’­å–Šå–®ç³»çµ±å»ºç½®
- **åŠŸèƒ½èªªæ˜**ï¼š
  1. **Facebook ç™»å…¥æ•´åˆ**
     - ä½¿ç”¨ OWIN æ­é… ASP.NET Identity å®Œæˆç¬¬ä¸‰æ–¹ç™»å…¥ã€‚
  
  2. **ç²‰çµ²åœ˜èŠå¤©å®¤è¨‚é–±ç®¡ç†**
     - ä½¿ç”¨ Redis å¿«å–ç²‰çµ²åœ˜èŠå¤©å®¤èˆ‡ SignalR ConnectId çš„å°æ‡‰é—œä¿‚ã€‚

  3. **Webhook æ¨æ’­è‡³èŠå¤©å®¤**
     - å¾Œå°æ¥æ”¶åˆ° webhook è¨Šæ¯å¾Œï¼ŒæŸ¥è©¢ Redis ä¸­å°æ‡‰ç²‰çµ²åœ˜èŠå¤©å®¤çš„ SignalR ConnectIdã€‚
     - ä½¿ç”¨ SignalR å°‡è¨Šæ¯å³æ™‚æ¨é€è‡³å°æ‡‰çš„èŠå¤©å®¤é€£ç·šç«¯ã€‚
	 
  4. **Facebook API æ¨é€è³¼ç‰©é€£çµ**
     - webhookæ”¶åˆ°è¨Šæ¯ç¶“éåˆ†æé—œéµå­—æ¯”å°å»åˆ,é€éfacebook apiç™¼é€è³¼ç‰©é€£çµçµ¦ç”¨æˆ¶ã€‚

- **æŠ€è¡“ä½¿ç”¨**ï¼šC#, ASP.NET MVC, MSSQL, Redis, SignalR, Facebook API, ASP.NET Identity, OWIN




## 3. ç¬¬ä¸‰æ–¹æ”¯ä»˜ä¸²æ¥
- **åŠŸèƒ½èªªæ˜**ï¼š
  1. æ–¼é›»å•†å¹³å°ä¸­ï¼Œè¨‚å–®æˆç«‹å¾Œè‡ªå‹•å°å‘ç¬¬ä¸‰æ–¹æ”¯ä»˜æµç¨‹ï¼Œä¸¦ä¾æ“šæ”¯ä»˜çµæœæ›´æ–°è¨‚å–®ç‹€æ…‹ã€‚
  2. æ”¯æ´å¤šç¨®æ”¯ä»˜å¹³å°ä¸²æ¥ï¼š
     - **LinePay**
     - **æ‚ éŠä»˜**
     - **iPASS ä¸€å¡é€š**
  3. ä¸²æ¥éç¨‹åŒ…å«ç°½ç« é©—è­‰ã€è¨‚å–®è™Ÿå°æ‡‰ã€å›å‚³çµæœè§£æèˆ‡ç•°å¸¸è™•ç†ã€‚

- **æŠ€è¡“ä½¿ç”¨**ï¼šC#, ASP.NET Core, ASP.NET MVC, MSSQL, Oracle, Redis

	
## 4. å°å…¥ Google Recaptcha é©—è­‰
- **åŠŸèƒ½èªªæ˜**ï¼š
  1. æ‡‰ç”¨æ–¼è¨»å†Šã€ç™»å…¥èˆ‡æ•æ„Ÿæ“ä½œï¼ˆå¦‚é‡è¨­å¯†ç¢¼ï¼‰ä¸­ï¼Œé˜²æ­¢æ©Ÿå™¨äººæ¿«ç”¨è¡Œç‚ºã€‚
  2. ä½¿ç”¨ Google Recaptchaï¼Œæå‡ç¶²ç«™å®‰å…¨æ€§èˆ‡ä½¿ç”¨è€…é«”é©—ã€‚
  3. å°‡é©—è­‰éç¨‹ç”¢ç”Ÿçš„åˆ†æ•¸ç´€éŒ„æ¥å…¥ ELK Log ç³»çµ±ï¼Œä¾›å¾ŒçºŒè¿½è¹¤èˆ‡èª¿æŸ¥ã€‚
  4. å°å…¥å¾Œè‡ªå‹•æ ¹æ“šé©—è­‰çµæœæ§åˆ¶æ˜¯å¦ç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæµç¨‹ã€‚

- **æŠ€è¡“ä½¿ç”¨**ï¼šC#, ASP.NET MVC, Google Recaptcha, ELK


## 5. Lineå¹³å°æ”¶é›†é›†åœ˜å®˜æ–¹å¸³è™Ÿwebhook

# WebHook è™•ç†é‚è¼¯ä¸­çš„è¨­è¨ˆæ¨¡å¼æ‡‰ç”¨

æœ¬æ®µç¨‹å¼ç¢¼é‹ç”¨äº†å…©ç¨®å¸¸è¦‹çš„è¨­è¨ˆæ¨¡å¼ï¼š

- **Factory Patternï¼ˆå·¥å» æ¨¡å¼ï¼‰**
- **Strategy Patternï¼ˆç­–ç•¥æ¨¡å¼ï¼‰**

é”æˆé«˜å½ˆæ€§ã€é«˜å¯ç¶­è­·æ€§çš„äº‹ä»¶è™•ç†æ©Ÿåˆ¶ã€‚

---

## ğŸ¯ Factory Pattern - å·¥å» æ¨¡å¼

### ä½¿ç”¨å ´æ™¯

ä½¿ç”¨ `IHandlerFactory` ä»‹é¢ + `GetHandler()` æ–¹æ³•ï¼Œæ ¹æ“š `WebHookEventType` å»ºç«‹å°æ‡‰çš„äº‹ä»¶è™•ç†å™¨ç‰©ä»¶ã€‚

### ç¨‹å¼ç¢¼ç¯„ä¾‹

```csharp
public interface IHandlerFactory
{
    IWebHookEventHandler GetHandler(WebHookEventType type, BotInfo botInfo, ILineBot bot);
}

public class HandlerFactory : IHandlerFactory
{
    public IWebHookEventHandler GetHandler(WebHookEventType type, BotInfo botInfo, ILineBot bot)
    {
        BaseWebHookEventHandler handler = type switch
        {
            WebHookEventType.Follow => new FollowWebHookEventHandler(...),
            WebHookEventType.Message => new MessageWebHookEventHandler(...),
            _ => new IdleWebHookEventHandler(...)
        };

        return handler;
    }
}

 public abstract class BaseWebHookEventHandler : IWebHookEventHandler
 {
     /// <summary>
     /// å„ handler å¯¦ä½œè™•ç†äº‹ä»¶
     /// </summary>
     protected abstract Task Handle(LineEvent lineEvent, BotInfo botInfo, DateTime executeTime);

     public async Task Execute(LineEvent lineEvent, BotInfo botInfo)
     {
         await Handle(lineEvent, botInfo, now);

         CreateWebhookEvent(WebHookEvent, now);
     }
  }
  public interface IWebHookEventHandler
  {

      Task Execute(LineEvent lineEvent, BotInfo botInfo);
  }

  public interface IMessageWebHookEventHandler : IWebHookEventHandler
  {}

public class FollowWebHookEventHandler : BaseWebHookEventHandler, IFollowWebHookEventHandler
{

    protected override async Task Handle(LineEvent lineEvent, BotInfo botInfo, DateTime executeTime)
    {
        var user = InittestUser(botInfo, profile, hashname, executeTime);

        _userModule.UpsertUser(user);
    }
}

```
# ç”¨ Event Storming é‡æ§‹é›»å•†ç³»çµ±ç‚º DDD æ¶æ§‹èˆ‡å¾®æœå‹™è¨­è¨ˆ

## ä»€éº¼æ˜¯ Event Stormingï¼Ÿ

Event Storming æ˜¯ç”± Alberto Brandolini æå‡ºçš„ä»¥ **äº‹ä»¶ç‚ºæ ¸å¿ƒ** çš„é ˜åŸŸå»ºæ¨¡æ–¹æ³•ï¼Œç›®çš„åœ¨æ–¼é›†çµæ¥­å‹™èˆ‡é–‹ç™¼äººå“¡ï¼Œç”¨è¦–è¦ºåŒ–æ–¹å¼ä¸€èµ·æ¢ç´¢ç³»çµ±çš„æ¥­å‹™æµç¨‹ã€‚

### åŸºæœ¬è¦ç´ 
- **Domain Eventï¼ˆæ©˜è‰²è²¼ç´™ï¼‰**ï¼šæ¥­å‹™ä¸Šç™¼ç”Ÿçš„äº‹ä»¶ï¼Œä¾‹å¦‚ã€Œè¨‚å–®å·²å»ºç«‹ã€ã€ã€Œä»˜æ¬¾æˆåŠŸã€ã€ã€Œç´…åŒ…å·²é ˜å–ã€ã€‚
- **Commandï¼ˆè—è‰²ï¼‰**ï¼šè§¸ç™¼è¡Œç‚ºçš„æŒ‡ä»¤ï¼Œå¦‚ã€Œå»ºç«‹è¨‚å–®ã€ã€ã€Œé ˜å–ç´…åŒ…ã€ã€‚
- **Aggregate / Entityï¼ˆé»ƒè‰²ï¼‰**ï¼šè² è²¬è™•ç†æŒ‡ä»¤çš„å¯¦é«”ã€‚
- **Read Model / Queryï¼ˆç¶ è‰²ï¼‰**ï¼šæŸ¥è©¢æ“ä½œã€‚
- **å¤–éƒ¨ç³»çµ± / UIï¼ˆç²‰ç´…ï¼‰**ï¼šäººæˆ–ç³»çµ±è§¸ç™¼äº‹ä»¶çš„ä¾†æºã€‚

---

## ç‚ºä»€éº¼ Event Storming èƒ½å¹«ä½ æ‰¾åˆ° Bounded Contextï¼Ÿ

**Bounded Context** æ˜¯ DDD ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼ŒæŒ‡çš„æ˜¯ä¸€å€‹æ˜ç¢ºçš„é‚Šç•Œï¼Œåœ¨é€™å€‹é‚Šç•Œå…§ï¼Œè©å½™ã€é‚è¼¯ã€è³‡æ–™æ¨¡å‹éƒ½æœ‰ä¸€è‡´å®šç¾©ã€‚

### èˆ‰ä¾‹ï¼ˆé›»å•†æ´»å‹•ç³»çµ±ï¼‰
å‡è¨­ä½ ç™¼ç¾ä»¥ä¸‹äº‹ä»¶ï¼š

- `ç´…åŒ…å·²å»ºç«‹`
- `ç´…åŒ…å·²é ˜å–`
- `ä½¿ç”¨è€…æœªé”æ¢ä»¶`
- `ç´…åŒ…åé¡å·²ç”¨ç›¡`

é€™äº›äº‹ä»¶èˆ‡ã€Œç´…åŒ…æ´»å‹•ã€å¼·è€¦åˆï¼Œå¯èƒ½æœƒæ­¸å±¬æ–¼ä¸€å€‹ `CampaignContext`ã€‚
è€Œåƒï¼š

- `è¨‚å–®å·²å®Œæˆ`
- `æœƒå“¡ç­‰ç´šå·²è®Šæ›´`

é€™äº›å‰‡å±¬æ–¼ `OrderContext` æˆ– `UserContext`ã€‚

ä½ å¯ä»¥ä¾æ“šã€Œäº‹ä»¶æ˜¯å¦å¸¸ä¸€èµ·ç™¼ç”Ÿã€ã€ã€Œè²¬ä»»æ˜¯å¦æ˜ç¢ºã€ä¾†æ‹†åˆ† Contextã€‚

---

## å°‡é›»å•†ç³»çµ±æ‹†æˆå¾®æœå‹™çš„å»ºè­°æ­¥é©Ÿ

### Step 1: ä½¿ç”¨ Event Storming æ‰¾å‡ºæ ¸å¿ƒæµç¨‹èˆ‡äº‹ä»¶
- ä»¥æ¥­å‹™äº‹ä»¶ç‚ºå‡ºç™¼é»ï¼Œä¸²èµ·æµç¨‹
- æ‰¾å‡ºä¸åŒæµç¨‹æ®µè½çš„ã€Œè² è²¬è€…ã€ï¼Œä¾‹å¦‚ç´…åŒ…è™•ç†è€… vs è¨‚å–®è™•ç†è€…

### Step 2: åŠƒåˆ† Bounded Context
- å°‡äº‹ä»¶ç¾¤çµ„èµ·ä¾†
- åŠƒå‡ºä¸åŒçš„èªæ„é‚Šç•Œï¼ˆä¾‹å¦‚ï¼šCampaignContextã€OrderContextã€UserContextï¼‰

### Step 3: å®šç¾©æ¯å€‹å¾®æœå‹™çš„è·è²¬
| å¾®æœå‹™åç¨± | è² è²¬è™•ç† | é—œæ³¨äº‹ä»¶ |
|------------|----------|-----------|
| CampaignService | æ´»å‹•å»ºç«‹èˆ‡é ˜å–é‚è¼¯ | ç´…åŒ…å·²å»ºç«‹ã€ç´…åŒ…å·²é ˜å–ã€ç´…åŒ…å¤±æ•— |
| OrderService | è¨‚å–®å»ºç«‹èˆ‡ä»˜æ¬¾ | è¨‚å–®å·²å»ºç«‹ã€è¨‚å–®å·²ä»˜æ¬¾ |
| UserService | ä½¿ç”¨è€…è³‡æ–™èˆ‡ç­‰ç´šç®¡ç† | æœƒå“¡ç­‰ç´šè®Šæ›´ã€ä½¿ç”¨è€…è³‡æ ¼ç¢ºèª |

### Step 4: å®šç¾©äº‹ä»¶äº¤æ›ï¼ˆEvent Busï¼‰
- ä½¿ç”¨ RabbitMQã€Kafka æˆ– Redis Stream ä¾†å¯¦ä½œäº‹ä»¶é€šçŸ¥
- å¾®æœå‹™ä¹‹é–“ä¸ç›´æ¥ç›¸ä¾ï¼Œè€Œæ˜¯é€éäº‹ä»¶äº’å‹•

---

## æ³¨æ„äº‹é …

- æ¯å€‹ Context è¦è‡ªå·±æ“æœ‰è³‡æ–™ï¼Œä¸å…±äº«è³‡æ–™è¡¨ï¼ˆåˆ†åº«è¨­è¨ˆï¼‰
- å¯å…ˆå¾å–®é«”å…§çš„æ¨¡çµ„åŒ–ï¼ˆModular Monolithï¼‰é–‹å§‹ï¼Œé€æ­¥æ‹†æˆå¾®æœå‹™
- è³‡æ–™ä¸€è‡´æ€§è™•ç†å¯ç”¨æœ€çµ‚ä¸€è‡´æ€§ + è£œå„Ÿæ©Ÿåˆ¶ï¼ˆSagaã€Outbox patternï¼‰

---

## å»¶ä¼¸é–±è®€
- Domain-Driven Design by Eric Evans
- Implementing DDD by Vaughn Vernon
- https://eventstorming.com/


# ğŸ” å¾®æœå‹™æ¶æ§‹ä¸‹çš„ç™»å…¥é©—è­‰èˆ‡ JWT è¨­è¨ˆ

## æ¦‚å¿µèªªæ˜

ç™»å…¥ç‹€æ…‹ä¸æ‡‰è©²åƒ…ä¾è³´ JWT å­˜åœ¨ï¼Œæ‡‰è©²é€é **Refresh Token æ§åˆ¶ç™»å…¥æœ‰æ•ˆæ€§**ã€‚

---

## ğŸ§± ç™»å…¥ç›¸é—œå…ƒä»¶è§’è‰²

| å…ƒä»¶             | èªªæ˜                                                                 |
|------------------|----------------------------------------------------------------------|
| Access Token     | çŸ­æ•ˆæˆæ¬Šæ†‘è­‰ï¼Œé™„å¸¶åœ¨æ¯æ¬¡ API è«‹æ±‚ä¸­ï¼Œé€šå¸¸ 5 ~ 15 åˆ†é˜éæœŸ              |
| Refresh Token    | é•·æ•ˆæ†‘è­‰ï¼Œç”¨æ–¼æ›ç™¼ Access Tokenï¼Œé€šå¸¸ä¿å­˜æ•¸å¤©æˆ–æ•¸é€±                     |
| ç™»å…¥ç‹€æ…‹æ§åˆ¶æ©Ÿåˆ¶ | ç”± Refresh Token åœ¨è³‡æ–™åº«ä¸­çš„å­˜åœ¨èˆ‡ç‹€æ…‹ï¼ˆæœ‰æ•ˆæœŸã€æ˜¯å¦æ’¤éŠ·ï¼‰æ±ºå®š         |

---

## ğŸ”„ ç™»å…¥èˆ‡æ›ç™¼æµç¨‹

1. ä½¿ç”¨è€…å¸³å¯†ç™»å…¥ï¼ˆLoginï¼‰
   - èªè­‰é€šéå¾Œç”¢ç”Ÿ Access Tokenï¼ˆçŸ­æ•ˆï¼‰èˆ‡ Refresh Tokenï¼ˆé•·æ•ˆï¼‰
   - Refresh Token å„²å­˜åœ¨ DBï¼Œä»£è¡¨ç™»å…¥ç‹€æ…‹

2. ä½¿ç”¨è€…å‘¼å« API æ™‚é™„å¸¶ Access Token
   - Token éæœŸæ™‚ï¼Œå¯ä½¿ç”¨ Refresh Token å‘ Auth Server æ›ç™¼æ–°çš„ Access Token

3. è‹¥ Refresh Token éæœŸæˆ–è¢«æ’¤éŠ·
   - å°‡ç„¡æ³•æ›ç™¼ï¼Œä½¿ç”¨è€…éœ€é‡æ–°ç™»å…¥

---

## ğŸšª ç™»å‡ºæµç¨‹

- å‘¼å« Logout APIï¼š
  - Server å´å°‡è©² Refresh Token æ¨™è¨˜ç‚º revoked æˆ–ç›´æ¥åˆªé™¤
  - è©² Token ä¸èƒ½å†è¢«ç”¨æ–¼æ›ç™¼ JWTï¼Œä»£è¡¨ç™»å‡ºæˆåŠŸ

---

## ğŸ§  æ³¨æ„äº‹é …èˆ‡å»ºè­°

| å•é¡Œ                          | è§£æ³•èˆ‡èªªæ˜                                                                 |
|-------------------------------|------------------------------------------------------------------------------|
| JWT éæœŸé‚„èƒ½ä¸€ç›´æ›ï¼Ÿ         | ä¸æœƒï¼Œå¦‚æœ Refresh Token æœ‰æ™‚æ•ˆèˆ‡æ’¤éŠ·é‚è¼¯                                 |
| å¦‚ä½•æ§ç®¡ç™»å…¥æ™‚æ•ˆï¼Ÿ           | é€é Refresh Token çš„æœ‰æ•ˆæœŸèˆ‡æ’¤éŠ·ç‹€æ…‹ç®¡ç†                                 |
| ç™»å‡ºæ€éº¼è™•ç†ï¼Ÿ               | æ¸…é™¤ Refresh Tokenï¼ˆå¾ DB ç§»é™¤æˆ–è¨­ç‚º revokedï¼‰                            |
| æ˜¯å¦éœ€è¦ Sessionï¼Ÿ           | ä¸éœ€è¦ä½¿ç”¨ ASP.NET Sessionï¼Œå¯ä¿æŒå¾®æœå‹™ stateless æ¶æ§‹                  |

---

## ğŸ§° ç¯„ä¾‹è³‡æ–™è¡¨è¨­è¨ˆï¼ˆRefresh Tokenï¼‰

```sql
CREATE TABLE RefreshTokens (
    Id UNIQUEIDENTIFIER PRIMARY KEY,
    UserId UNIQUEIDENTIFIER NOT NULL,
    Token NVARCHAR(200) NOT NULL,
    ExpiresAt DATETIME NOT NULL,
    Revoked BIT NOT NULL DEFAULT 0,
    CreatedAt DATETIME NOT NULL
);
